<!DOCTYPE html>
<html>

<head>

    <script src="/socket.io/socket.io.js" type="text/javascript"></script>
    <script src="https://cdn.jsdelivr.net/npm/normalizr@3.6.1/dist/normalizr.browser.min.js"
        type="text/javascript"></script>


    <script>

        const normalize = normalizr;
        const schema = normalizr.schema;
        //        const desnormalize = normalize.e.desnormalize;
        const authorSchema = new schema.Entity('author')

        const mensajeSchema = new schema.Entity('text', {
            author: authorSchema,
        });




        const socket = io.connect();

        socket.on('messages', data => {
            console.log(data)
            mostrarListado(data)

        })

        socket.on('mensajes', data => {

            let b = data.map(dat => {
                let a = normalize.denormalize(dat.result, mensajeSchema, dat.entities)
                return a
            })


            console.log(b)
            console.log(data)
            mostrarListadoMsj(b)

        })

        const mostrarListado = (list) => {


            const html = list.map((element, index) => {

                return (`
    <div>
        <strong> ${element.title} </strong>
    </div>
    `

                )
            }).join(' ')

            document.getElementById('listado').innerHTML = html;
        }

        const mostrarListadoMsj = (list) => {

            console.log(list);
            const html = list.map((element, index) => {

                return (`
        <div>
            <strong> ${element.author.name} </strong> - <strong> ${element.text} </strong>
        </div>
        `

                )
            }).join(' ')

            document.getElementById('mensajes').innerHTML = html;
        }




        const enviarForm = () => {
            const envio = {
                title: document.getElementById('nombre').value,
                price: document.getElementById('precio').value,
                thumbnail: document.getElementById('imagen').value
            }
            socket.emit('new-product', envio)

            document.getElementById('nombre').value = ''
            document.getElementById('precio').value = ''
            document.getElementById('imagen').value = ''

            return false
        }


        const enviarMensaje = () => {
            const envio = {
                id: document.getElementById('id').value,
                name: document.getElementById('name').value,
                apellido: document.getElementById('apellido').value,
                edad: document.getElementById('edad').value,
                alias: document.getElementById('alias').value,
                avatar: document.getElementById('avatar').value,
                text: document.getElementById('text').value
            }
            socket.emit('new-mensaje', envio)

            document.getElementById('email').value = ''
            document.getElementById('mj').value = ''

            return false
        }

    </script>

</head>

<body>

    <form onsubmit="return enviarForm(this)">
        <p>Nombre: <input type="text" id="nombre" name="nombre" size="40"></p>
        <p>Precio: <input type="text" name="price" id="precio" size="40"></p>
        <p>Imagen: <input type="text" name="thumbnail" id="imagen" size="40"></p>
        <p>
            <input type="submit" value="Enviar">
        </p>


    </form>
    <button><a href="http://localhost:8080/productos"> Ver productos </a> </button>

    <h2>Productos</h2>
    <div id="listado">


    </div>
    <h2>Centro de Mensajes</h2>

    <form onsubmit="return enviarMensaje(this)">
        <p>ID: <input type="text" id="id" name="id" size="40"></p>
        <p>Nombre: <input type="text" id="name" name="name" size="40"></p>
        <p>Apellido: <input type="text" id="apellido" name="apellido" size="40"></p>
        <p>Edad: <input type="text" id="edad" name="edad" size="40"></p>
        <p>Alias: <input type="text" id="alias" name="alias" size="40"></p>
        <p>Avatar: <input type="text" id="avatar" name="avatar" size="40"></p>
        <p>Mensaje: <input type="text" name="text" id="text" size="40"></p>

        <p>
            <input type="submit" value="Enviar">
        </p>
        <div id="mensajes"> </div>

</body>

</html>